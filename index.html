<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Strava Design Studio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;700;900&family=Lato:wght@400;700;900&family=Merriweather:wght@400;700;900&family=Montserrat:wght@400;700;900&family=Nunito:wght@400;700;900&family=Open+Sans:wght@400;700&family=Oswald:wght@400;700&family=Playfair+Display:wght@400;700&family=Poppins:wght@400;700&family=Roboto+Mono:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --accent: #fc4c02;
            --bg-dark: #0f0f10;
            --panel-bg: #18181b;
            --text-main: #ffffff;
            --text-muted: #a1a1aa;
            --border: #27272a;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 15px;
            box-sizing: border-box;
        }

        /* --- MODAL (POPUP) STƒ∞LLERƒ∞ --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .modal-content {
            background: #222;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            max-width: 100%;
            max-height: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid var(--accent);
            overflow-y: auto;
        }

        .modal-img {
            max-width: 100%;
            max-height: 60vh;
            border: 1px dashed #555;
            background-image: linear-gradient(45deg, #333 25%, transparent 25%), linear-gradient(-45deg, #333 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #333 75%), linear-gradient(-45deg, transparent 75%, #333 75%);
            background-size: 20px 20px;
            background-color: #1a1a1a;
            margin: 15px 0;
        }

        .modal-instructions {
            color: white;
            font-size: 1rem;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .modal-instructions span {
            color: var(--accent);
            font-weight: bold;
            display: block;
            font-size: 1.2rem;
            margin-top: 5px;
        }

        .close-btn {
            background: #444;
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        /* --- HEADER ALANI --- */
        .header-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 1400px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 { 
            font-weight: 900; 
            letter-spacing: -1px; 
            margin: 0; 
            font-size: 1.8rem; 
            white-space: nowrap;
        }
        h1 span { color: var(--accent); }

        .lang-selector { flex-shrink: 0; }

        .lang-selector select {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            appearance: none;
            -webkit-appearance: none;
            text-align: center;
        }

        /* --- ANA D√úZEN --- */
        .layout {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
            width: 100%;
            max-width: 1400px;
        }

        .sidebar {
            flex: 1;
            min-width: 340px;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel-box {
            background: var(--panel-bg);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        .panel-title {
            font-size: 0.9rem;
            font-weight: 800;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .full-width { grid-column: span 2; }

        .input-group label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 6px;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 12px;
            background: #27272a;
            border: 1px solid #3f3f46;
            color: white;
            border-radius: 8px;
            font-family: inherit; 
            font-size: 1rem;
            box-sizing: border-box;
            transition: 0.2s;
        }
        
        #fontSelect { font-size: 1rem; }
        #fontSelect option[value="Inter"] { font-family: 'Inter', sans-serif; font-weight: 900; }
        #fontSelect option[value="Bebas Neue"] { font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px; }
        #fontSelect option[value="Oswald"] { font-family: 'Oswald', sans-serif; }
        #fontSelect option[value="Montserrat"] { font-family: 'Montserrat', sans-serif; }
        #fontSelect option[value="Playfair Display"] { font-family: 'Playfair Display', serif; }
        #fontSelect option[value="Roboto Mono"] { font-family: 'Roboto Mono', monospace; }
        #fontSelect option[value="Merriweather"] { font-family: 'Merriweather', serif; }
        #fontSelect option[value="Poppins"] { font-family: 'Poppins', sans-serif; }
        #fontSelect option[value="Open Sans"] { font-family: 'Open Sans', sans-serif; }
        #fontSelect option[value="Nunito"] { font-family: 'Nunito', sans-serif; }
        #fontSelect option[value="Lato"] { font-family: 'Lato', sans-serif; }

        input:focus, select:focus {
            border-color: var(--accent);
            outline: none;
            background: #3f3f46;
        }

        input[type="range"] {
            padding: 0; 
            height: 30px; 
        }

        .customizer-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 10px;
            background: #222;
            border-radius: 8px;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            width: 100%;
        }
        input[type="checkbox"] { width: 22px; height: 22px; accent-color: var(--accent); flex-shrink: 0; }

        .logo-section { margin-bottom: 20px; }
        
        .file-upload {
            position: relative;
            display: block;
            width: 100%;
            text-align: center;
            padding: 20px 0;
            border: 2px dashed #444;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.3s;
            background: rgba(255,255,255,0.02);
            margin-top: 10px;
        }
        .file-upload:hover { border-color: var(--accent); background: rgba(252, 76, 2, 0.05); }
        .file-input { position: absolute; width: 100%; height: 100%; top:0; left:0; opacity: 0; cursor: pointer;}
        .hidden { display: none; }

        .btn-primary {
            width: 100%;
            padding: 18px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: 0.2s;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(252, 76, 2, 0.3);
        }
        .btn-primary:hover { background: #e34402; transform: translateY(-2px); }

        .preview-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 340px;
        }

        .canvas-wrapper {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border: 1px solid #333;
            background-image: 
                linear-gradient(45deg, #333 25%, transparent 25%), 
                linear-gradient(-45deg, #333 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #333 75%), 
                linear-gradient(-45deg, transparent 75%, #333 75%);
            background-size: 20px 20px;
            background-color: #1a1a1a;
            width: 100%;
        }

        canvas { display: block; width: 100%; height: auto; }

        .helper-text {
            margin-top: 15px;
            font-size: 0.85rem;
            color: var(--text-muted);
            text-align: center;
            max-width: 400px;
        }
        
        .res-badge {
            margin-top: 8px;
            font-size: 0.75rem;
            color: #666;
            background: #222;
            padding: 4px 10px;
            border-radius: 10px;
            border: 1px solid #333;
            font-family: monospace;
        }
        
        #gpxStatus {
            font-size: 0.85rem;
            color: var(--accent);
            margin-top: 5px;
            min-height: 1.2em;
        }

        @media (max-width: 768px) {
            .header-area {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            .lang-selector, .lang-selector select { width: 100%; text-align-last: center; }
            .sidebar, .preview-area { min-width: 100%; }
            .form-grid { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
        }
    </style>
</head>
<body>

    <!-- MODAL -->
    <div id="saveModal" class="modal-overlay" onclick="if(event.target === this) closeModal()">
        <div class="modal-content">
            <div class="modal-instructions">
                Galeriye kaydetmek i√ßin:
                <span>üëá G√∂rsele Basƒ±lƒ± Tut üëá</span>
                ve "Fotoƒüraflara Kaydet" deyin.
            </div>
            <img id="finalImage" class="modal-img" src="" alt="Final G√∂rsel">
            <button class="close-btn" onclick="closeModal()">KAPAT</button>
        </div>
    </div>

    <div class="header-area">
        <h1>Strava<span>Design</span> Studio</h1>
        <div class="lang-selector">
            <select id="langSelect" onchange="changeLanguage()">
                <option value="tr" selected>üáπüá∑ T√ºrk√ße</option>
                <option value="en">üá¨üáß English</option>
            </select>
        </div>
    </div>

    <div class="layout">
        <!-- SOL TARAFLAR: AYARLAR -->
        <div class="sidebar">
            
            <!-- 1. VERƒ∞LER & GPX -->
            <div class="panel-box">
                <div class="panel-title" id="t-panel1">1. Aktivite Verileri</div>
                
                <!-- GPX Y√úKLEME -->
                <div class="file-upload" style="margin-bottom: 20px; border-color: #666;">
                    <span id="gpxText">üìÇ GPX Dosyasƒ± Y√ºkle (Otomatik Doldur)</span>
                    <input type="file" class="file-input" accept=".gpx" onchange="handleGpxUpload(this)">
                </div>
                <div id="gpxStatus"></div>

                <div class="form-grid">
                    <div class="full-width input-group">
                        <label id="t-title">Ba≈ülƒ±k</label>
                        <input type="text" id="title" value="Sunday Morning Run" oninput="triggerDraw()">
                    </div>
                    
                    <div class="input-group">
                        <label id="t-distance">Mesafe (km)</label>
                        <input type="number" id="distance" value="10.5" step="0.01" oninput="calculatePace()">
                    </div>

                    <div class="input-group">
                        <label id="t-time">S√ºre (sa:dk:sn)</label>
                        <input type="text" id="time" value="00:55:00" placeholder="00:55:00" oninput="calculatePace()">
                    </div>

                    <div class="input-group">
                        <label id="t-pace">Tempo (dk/km)</label>
                        <input type="text" id="pace" value="5:14" readonly style="background:#333; color:#aaa; cursor:not-allowed;">
                    </div>

                    <div class="input-group">
                        <label>GAP (Grade Adjusted)</label>
                        <input type="text" id="gap" value="5:14" oninput="triggerDraw()">
                    </div>

                    <div class="input-group">
                        <label id="t-elevation">Toplam Y√ºkselme (m)</label>
                        <input type="number" id="elevation" value="145" oninput="triggerDraw()">
                    </div>

                    <div class="input-group">
                        <label id="t-calories">Kalori (kcal)</label>
                        <input type="number" id="calories" value="850" oninput="triggerDraw()">
                    </div>

                    <div class="input-group">
                        <label id="t-hr">Ort. Nabƒ±z (bpm)</label>
                        <input type="number" id="hr" value="152" oninput="triggerDraw()">
                    </div>
                </div>
            </div>

            <!-- 2. TASARIM & LOGO -->
            <div class="panel-box">
                <div class="panel-title" id="t-panel2">2. G√∂r√ºn√ºm & Logo</div>
                
                <!-- FONT SE√áƒ∞Mƒ∞ -->
                <div class="input-group" style="margin-bottom:15px;">
                    <label id="t-font">Yazƒ± Tipi (Font)</label>
                    <select id="fontSelect" onchange="handleFontChange()">
                        <option value="Inter" selected>Inter (Orijinal Kalƒ±n)</option>
                        <option value="Bebas Neue">Bebas Neue (Sportif/Poster)</option>
                        <option value="Oswald">Oswald (Sert/Dar)</option>
                        <option value="Montserrat">Montserrat (Geometrik)</option>
                        <option value="Poppins">Poppins (Yuvarlak/Modern)</option>
                        <option value="Roboto">Roboto (Klasik Android)</option>
                        <option value="Open Sans">Open Sans (Okunaklƒ±)</option>
                        <option value="Lato">Lato (Sƒ±cak/Dengeli)</option>
                        <option value="Nunito">Nunito (Yuvarlak/Yumu≈üak)</option>
                        <option value="Playfair Display">Playfair Display (Serif/Zarif)</option>
                        <option value="Merriweather">Merriweather (Serif/Ciddi)</option>
                        <option value="Roboto Mono">Roboto Mono (Teknik/Kod)</option>
                    </select>
                </div>
                
                <!-- GRAFƒ∞K SE√áƒ∞Mƒ∞ & AYARLAR -->
                <div class="input-group" style="margin-bottom:15px;">
                    <label id="t-graph">Grafik (GPX Gereklidir)</label>
                    <select id="graphSelect" onchange="triggerDraw()">
                        <option value="none">üö´ Yok (None)</option>
                        <option value="hr" selected>‚ù§Ô∏è Nabƒ±z (Heart Rate)</option>
                        <option value="elevation">‚õ∞Ô∏è ƒ∞rtifa (Elevation)</option>
                        <option value="pace">‚ö° Tempo (Pace/Speed)</option>
                    </select>
                </div>

                <div class="form-grid" style="margin-bottom: 15px;">
                     <div class="input-group">
                        <label id="t-graph-pos">Grafik Konumu</label>
                        <input type="range" id="graphYPos" min="200" max="800" value="520" oninput="triggerDraw()">
                    </div>
                    <div class="input-group">
                        <label id="t-graph-color">Grafik Rengi</label>
                        <select id="graphColor" onchange="triggerDraw()">
                            <option value="#fc4c02" selected id="opt-color-orange">üçä Turuncu</option>
                            <option value="#ffffff" id="opt-color-white">‚ö™ Beyaz</option>
                            <option value="#3b82f6" id="opt-color-blue">üîµ Mavi</option>
                        </select>
                    </div>
                </div>

                <!-- LOGO SE√áƒ∞M ALANI -->
                <div class="logo-section">
                    <div class="input-group">
                        <label id="t-logo-select">Logo Se√ßimi</label>
                        <select id="logoSource" onchange="handleLogoSelection()">
                            <option value="custom" id="opt-custom">üìÅ √ñzel Y√ºkle (Custom)</option>
                            <option value="bold" id="opt-bold">ü¶• Bold Union</option>
                            <option value="runurban" id="opt-runurban">Run Urban</option>
                        </select>
                    </div>

                    <!-- YENƒ∞ LOGO BOYUT SLIDER'I -->
                    <div class="input-group" style="margin-top: 10px;">
                        <label id="t-logo-size">Logo Boyutu</label>
                        <input type="range" id="logoSize" min="0.5" max="2.0" step="0.1" value="1.0" oninput="triggerDraw()">
                    </div>

                    <!-- Dosya Y√ºkleme -->
                    <div id="customUploadArea" class="file-upload">
                        <span id="uploadText" style="font-size: 0.9rem; color:#ccc;">‚ûï Logo Se√ßmek ƒ∞√ßin Tƒ±kla</span>
                        <input type="file" class="file-input" accept="image/*" onchange="handleCustomLogo(this)">
                    </div>
                </div>

                <div class="input-group" style="margin-bottom:15px;">
                    <label id="t-hero">üëë ANA G√ñSTERGE</label>
                    <select id="heroMetric" onchange="triggerDraw()">
                        <option value="distance" id="opt-dist">Mesafe (km)</option>
                        <option value="time" id="opt-time">S√ºre</option>
                        <option value="pace" id="opt-hero-pace">Ort. Tempo</option>
                        <option value="calories" id="opt-cal">Kalori</option>
                        <option value="hr" id="opt-hr">Nabƒ±z</option>
                        <option value="elevation" id="opt-ele">ƒ∞rtifa</option>
                    </select>
                </div>

                <label id="t-sub" style="display:block; margin-bottom:10px; font-size:0.75rem; color:#aaa;">üëá ALT G√ñSTERGELER</label>
                
                <div class="customizer-row">
                    <label class="checkbox-label"><input type="checkbox" class="stat-check" value="time" checked onchange="triggerDraw()"> <span id="chk-time">S√ºre</span></label>
                    <label class="checkbox-label"><input type="checkbox" class="stat-check" value="pace" checked onchange="triggerDraw()"> <span id="chk-pace">Ort. Tempo</span></label>
                </div>
                <div class="customizer-row">
                    <label class="checkbox-label"><input type="checkbox" class="stat-check" value="hr" checked onchange="triggerDraw()"> <span id="chk-hr">Nabƒ±z</span></label>
                    <label class="checkbox-label"><input type="checkbox" class="stat-check" value="calories" checked onchange="triggerDraw()"> <span id="chk-cal">Kalori</span></label>
                </div>
                <div class="customizer-row">
                    <label class="checkbox-label"><input type="checkbox" class="stat-check" value="elevation" checked onchange="triggerDraw()"> <span id="chk-ele">ƒ∞rtifa</span></label>
                    <label class="checkbox-label"><input type="checkbox" class="stat-check" value="gap" onchange="triggerDraw()"> GAP</label>
                </div>

                <div class="customizer-row" style="margin-top:15px; border-top:1px solid #333; padding-top:10px;">
                    <label class="checkbox-label" style="width:100%">
                        <input type="checkbox" id="showShadow" checked onchange="triggerDraw()"> 
                        <span id="chk-shadow">Arka Plan G√∂lgesi (Okunurluk)</span>
                    </label>
                </div>

                <div class="input-group" style="margin-top:15px;">
                    <label id="t-pos">Pozisyon (Y√ºkseklik Ayarƒ±)</label>
                    <input type="range" id="yPos" min="100" max="1500" value="1200" oninput="triggerDraw()">
                </div>
            </div>

            <button class="btn-primary" id="btn-download" onclick="openSaveModal()">üì± G√ñRSELƒ∞ HAZIRLA (KAYDET)</button>
        </div>

        <!-- SAƒû: CANVAS -->
        <div class="preview-area">
            <div class="canvas-wrapper">
                <canvas id="mainCanvas" width="1080" height="1920"></canvas>
            </div>
            <p class="helper-text" id="t-helper">√áƒ±ktƒ± ≈üeffaf (transparent) olacaktƒ±r. √ñnizlemedeki kareli zemin ≈üeffaflƒ±ƒüƒ± temsil eder.</p>
            <div class="res-badge">Target Resolution: 1080 x 1920 px</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        let userLogo = null;
        let currentLang = 'tr';
        
        // GPX Veri Saklama
        let gpxData = {
            hr: [],
            elevation: [],
            pace: [],
            distance: 0,
            totalTime: 0,
            elevationGain: 0,
            avgHr: 0
        };

        // Dƒ∞L VERƒ∞TABANI
        const translations = {
            tr: {
                panel1: "1. Aktivite Verileri",
                title: "Ba≈ülƒ±k",
                distance: "Mesafe (km)",
                time: "S√ºre",
                pace: "Tempo (dk/km)",
                elevation: "Top. Y√ºkselme (m)",
                calories: "Kalori (kcal)",
                hr: "Ort. Nabƒ±z (bpm)",
                panel2: "2. G√∂r√ºn√ºm & Logo",
                logoSelect: "Logo Se√ßimi",
                logoSize: "Logo Boyutu",
                optCustom: "üìÅ √ñzel Y√ºkle (Custom)",
                optBold: "ü¶• Bold Union",
                optRunUrban: "Run Urban",
                uploadText: "‚ûï Logo Se√ßmek ƒ∞√ßin Tƒ±kla",
                logoReady: "‚úÖ Logo Hazƒ±r",
                gpxText: "üìÇ GPX Y√ºkle (Otomatik Doldur)",
                gpxReady: "‚úÖ GPX Verileri Y√ºklendi!",
                graphLabel: "Grafik (GPX Gereklidir)",
                graphPos: "Grafik Konumu",
                graphColor: "Grafik Rengi",
                colOrange: "üçä Turuncu",
                colWhite: "‚ö™ Beyaz",
                colBlue: "üîµ Mavi",
                hero: "üëë ANA G√ñSTERGE",
                sub: "üëá ALT G√ñSTERGELER",
                pos: "Pozisyon (Y√ºkseklik Ayarƒ±)",
                btnDownload: "üì± G√ñRSELƒ∞ HAZIRLA (KAYDET)",
                helper: "√áƒ±ktƒ± ≈üeffaf (transparent) olacaktƒ±r. √ñnizlemedeki kareli zemin ≈üeffaflƒ±ƒüƒ± temsil eder.",
                optDist: "Mesafe (km)",
                optTime: "S√ºre",
                optHeroPace: "Ort. Tempo",
                optCal: "Kalori",
                optHr: "Nabƒ±z",
                optEle: "ƒ∞rtifa",
                chkPace: "Ort. Tempo",
                c_distance: "Mesafe",
                c_time: "S√ºre",
                c_pace: "Ort. Tempo",
                c_elevation: "Top. Y√ºkselme",
                c_calories: "Kalori",
                c_hr: "Ort. Nabƒ±z",
                chkShadow: "Arka Plan G√∂lgesi (Okunurluk)",
                fontLabel: "Yazƒ± Tipi (Font)",
                modalTitle: "Galeriye kaydetmek i√ßin:",
                modalAction: "üëá G√∂rsele Basƒ±lƒ± Tut üëá",
                modalEnd: "ve 'Fotoƒüraflara Kaydet' deyin.",
                close: "KAPAT",
                graphNone: "üö´ Yok (None)",
                graphHr: "‚ù§Ô∏è Nabƒ±z (Heart Rate)",
                graphEle: "‚õ∞Ô∏è ƒ∞rtifa (Elevation)",
                graphPace: "‚ö° Tempo (Pace/Speed)"
            },
            en: {
                panel1: "1. Activity Data",
                title: "Title",
                distance: "Distance (km)",
                time: "Time",
                pace: "Pace (min/km)",
                elevation: "Total Ascent (m)",
                calories: "Calories (kcal)",
                hr: "Avg HR (bpm)",
                panel2: "2. Appearance & Logo",
                logoSelect: "Logo Selection",
                logoSize: "Logo Size",
                optCustom: "üìÅ Upload Custom",
                optBold: "ü¶• Bold Union",
                optRunUrban: "Run Urban",
                uploadText: "‚ûï Click to Select Logo",
                logoReady: "‚úÖ Logo Ready",
                gpxText: "üìÇ Upload GPX (Auto-fill)",
                gpxReady: "‚úÖ GPX Data Loaded!",
                graphLabel: "Graph (Requires GPX)",
                graphPos: "Graph Position",
                graphColor: "Graph Color",
                colOrange: "üçä Orange",
                colWhite: "‚ö™ White",
                colBlue: "üîµ Blue",
                hero: "üëë MAIN METRIC",
                sub: "üëá SUB METRICS",
                pos: "Position (Vertical Offset)",
                btnDownload: "üì± PREPARE IMAGE (SAVE)",
                helper: "Output will be transparent. The checkerboard pattern represents transparency.",
                optDist: "Distance (km)",
                optTime: "Time",
                optHeroPace: "Avg Pace",
                optCal: "Calories",
                optHr: "Heart Rate",
                optEle: "Elevation",
                chkPace: "Avg Pace",
                c_distance: "Distance",
                c_time: "Time",
                c_pace: "Avg Pace",
                c_elevation: "Total Ascent",
                c_calories: "Calories",
                c_hr: "Avg HR",
                chkShadow: "Background Shadow (Readability)",
                fontLabel: "Font Family",
                modalTitle: "To save to Gallery:",
                modalAction: "üëá Long Press Image üëá",
                modalEnd: "and select 'Save to Photos'.",
                close: "CLOSE",
                graphNone: "üö´ None",
                graphHr: "‚ù§Ô∏è Heart Rate",
                graphEle: "‚õ∞Ô∏è Elevation",
                graphPace: "‚ö° Pace/Speed"
            }
        };

        // --- BA≈ûLANGI√á VE FONT Y√ñNETƒ∞Mƒ∞ ---
        window.onload = function() {
            changeLanguage();
            calculatePace();
            
            document.fonts.load('900 10px "Inter"').then(() => {
                draw();
            }).catch(() => {
                draw();
            });

            setTimeout(draw, 500);
        };

        function handleFontChange() {
            const selectedFont = document.getElementById('fontSelect').value;
            document.fonts.load(`10px "${selectedFont}"`).then(() => {
                draw();
            });
        }

        function triggerDraw() {
            requestAnimationFrame(draw);
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function changeLanguage() {
            currentLang = document.getElementById('langSelect').value;
            const t = translations[currentLang];

            document.getElementById('t-panel1').innerText = t.panel1;
            document.getElementById('t-title').innerText = t.title;
            document.getElementById('t-distance').innerText = t.distance;
            document.getElementById('t-time').innerText = t.time;
            document.getElementById('t-pace').innerText = t.pace;
            document.getElementById('t-elevation').innerText = t.elevation;
            document.getElementById('t-calories').innerText = t.calories;
            document.getElementById('t-hr').innerText = t.hr;
            
            document.getElementById('t-panel2').innerText = t.panel2;
            document.getElementById('t-logo-select').innerText = t.logoSelect;
            document.getElementById('t-logo-size').innerText = t.logoSize;
            document.getElementById('opt-custom').innerText = t.optCustom;
            document.getElementById('opt-bold').innerText = t.optBold;
            document.getElementById('opt-runurban').innerText = t.optRunUrban;
            
            if(document.getElementById('logoSource').value === 'custom' && !userLogo) {
                document.getElementById('uploadText').innerText = t.uploadText;
            }
            
            // GPX Text Update
            if(gpxData.distance === 0) {
                 document.getElementById('gpxText').innerText = t.gpxText;
            } else {
                 document.getElementById('gpxText').innerText = t.gpxReady;
                 document.getElementById('gpxStatus').innerText = t.gpxReady;
            }
            
            document.getElementById('t-graph').innerText = t.graphLabel;
            document.getElementById('t-graph-pos').innerText = t.graphPos;
            document.getElementById('t-graph-color').innerText = t.graphColor;

            document.querySelector('#graphSelect option[value="none"]').innerText = t.graphNone;
            document.querySelector('#graphSelect option[value="hr"]').innerText = t.graphHr;
            document.querySelector('#graphSelect option[value="elevation"]').innerText = t.graphEle;
            document.querySelector('#graphSelect option[value="pace"]').innerText = t.graphPace;

            document.getElementById('opt-color-orange').innerText = t.colOrange;
            document.getElementById('opt-color-white').innerText = t.colWhite;
            document.getElementById('opt-color-blue').innerText = t.colBlue;

            document.getElementById('t-hero').innerText = t.hero;
            document.getElementById('t-sub').innerText = t.sub;
            document.getElementById('t-pos').innerText = t.pos;
            document.getElementById('btn-download').innerText = t.btnDownload;
            document.getElementById('t-helper').innerText = t.helper;
            
            document.getElementById('t-font').innerText = t.fontLabel;

            document.getElementById('opt-dist').innerText = t.optDist;
            document.getElementById('opt-time').innerText = t.optTime;
            document.getElementById('opt-hero-pace').innerText = t.optHeroPace;
            document.getElementById('opt-cal').innerText = t.optCal;
            document.getElementById('opt-hr').innerText = t.optHr;
            document.getElementById('opt-ele').innerText = t.optEle;

            document.getElementById('chk-time').innerText = t.optTime;
            document.getElementById('chk-pace').innerText = t.chkPace;
            document.getElementById('chk-hr').innerText = t.optHr;
            document.getElementById('chk-cal').innerText = t.optCal;
            document.getElementById('chk-ele').innerText = t.optEle;
            
            document.getElementById('chk-shadow').innerText = t.chkShadow;

            // Modal text
            const modalText = document.querySelector('.modal-instructions');
            if(modalText) {
                modalText.innerHTML = `${t.modalTitle} <span>${t.modalAction}</span> ${t.modalEnd}`;
            }
            document.querySelector('.close-btn').innerText = t.close;

            draw();
        }

        // --- GPX PARSER ---
        function handleGpxUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                parseGpx(text);
            };
            reader.readAsText(file);
        }

        function parseGpx(xmlStr) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlStr, "text/xml");
            const trkpts = xmlDoc.querySelectorAll('trkpt');
            
            // Reset Data
            gpxData = { hr: [], elevation: [], pace: [], distance: 0, totalTime: 0, elevationGain: 0, avgHr: 0 };
            
            let totalHr = 0;
            let hrCount = 0;
            let prevTime = null;
            let prevLat = null;
            let prevLon = null;
            let minEle = 9999;

            // Simple Haversine for distance
            function getDist(lat1, lon1, lat2, lon2) {
                const R = 6371e3; // metres
                const œÜ1 = lat1 * Math.PI/180;
                const œÜ2 = lat2 * Math.PI/180;
                const ŒîœÜ = (lat2-lat1) * Math.PI/180;
                const ŒîŒª = (lon2-lon1) * Math.PI/180;
                const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                        Math.cos(œÜ1) * Math.cos(œÜ2) *
                        Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            for (let i = 0; i < trkpts.length; i++) {
                const pt = trkpts[i];
                const ele = parseFloat(pt.querySelector('ele')?.textContent || 0);
                const timeStr = pt.querySelector('time')?.textContent;
                const time = new Date(timeStr).getTime();
                
                // Extract HR (try different namespaces)
                let hr = 0;
                const extensions = pt.querySelector('extensions');
                if(extensions) {
                    // Try common HR tags
                    const hrTag = extensions.querySelector('hr') || 
                                  extensions.getElementsByTagNameNS('*', 'hr')[0] ||
                                  extensions.getElementsByTagName('gpxtpx:hr')[0];
                    if(hrTag) hr = parseInt(hrTag.textContent);
                }

                // Store Data Points
                if (hr > 0) {
                    gpxData.hr.push(hr);
                    totalHr += hr;
                    hrCount++;
                }
                
                gpxData.elevation.push(ele);
                
                if (i > 0) {
                    const lat = parseFloat(pt.getAttribute('lat'));
                    const lon = parseFloat(pt.getAttribute('lon'));
                    
                    const dist = getDist(prevLat, prevLon, lat, lon);
                    gpxData.distance += dist;
                    
                    const timeDiff = (time - prevTime) / 1000; // seconds
                    
                    // Calculate Speed/Pace (Smoothing will happen in draw)
                    // Only calculate if moving
                    if (dist > 0 && timeDiff > 0) {
                        const speedMps = dist / timeDiff;
                        // Pace (min/km) = (1000 / speed) / 60
                        const paceVal = (1000 / speedMps) / 60;
                        if(paceVal < 30) gpxData.pace.push(paceVal); // Filter out stops
                        else gpxData.pace.push(gpxData.pace[gpxData.pace.length-1] || 0);
                    } else {
                         gpxData.pace.push(gpxData.pace[gpxData.pace.length-1] || 0);
                    }
                    
                    if(ele > minEle + 0.5) { // Simple gain filter
                       // gpxData.elevationGain += (ele - minEle);
                    }
                    minEle = ele; // Logic for gain is complex, simplifying...
                } else {
                    minEle = ele;
                    gpxData.pace.push(0);
                }
                
                prevLat = parseFloat(pt.getAttribute('lat'));
                prevLon = parseFloat(pt.getAttribute('lon'));
                prevTime = time;
            }
            
            // Fill Inputs
            const totalKm = (gpxData.distance / 1000).toFixed(2);
            document.getElementById('distance').value = totalKm;
            
            // Total Time (Start to Finish)
            const startTime = new Date(trkpts[0].querySelector('time').textContent).getTime();
            const endTime = new Date(trkpts[trkpts.length-1].querySelector('time').textContent).getTime();
            const diffMs = endTime - startTime;
            const diffSec = Math.floor(diffMs / 1000);
            const h = Math.floor(diffSec / 3600);
            const m = Math.floor((diffSec % 3600) / 60);
            const s = diffSec % 60;
            const timeFmt = `${h}:${m<10?'0':''}${m}:${s<10?'0':''}${s}`;
            document.getElementById('time').value = timeFmt;
            
            // Elevation Gain (Simple approximation: Max - Min or sum of climbs)
            // For robustness, let's just grab the last ele if available or let user edit.
            // Actually let's do a simple ascent calc
            let ascent = 0;
            for(let k=1; k<gpxData.elevation.length; k++) {
                const diff = gpxData.elevation[k] - gpxData.elevation[k-1];
                if(diff > 0.2) ascent += diff;
            }
            document.getElementById('elevation').value = Math.round(ascent);
            
            if(hrCount > 0) {
                document.getElementById('hr').value = Math.round(totalHr / hrCount);
            }
            
            calculatePace(); // Update pace field
            
            document.getElementById('gpxText').innerText = translations[currentLang].gpxReady;
            document.getElementById('gpxStatus').innerText = translations[currentLang].gpxReady;
            
            draw();
        }

        // --- LOGO & MODAL ƒ∞≈ûLEMLERƒ∞ ---
        
        function openSaveModal() {
            const dataUrl = canvas.toDataURL("image/png");
            const finalImg = document.getElementById('finalImage');
            finalImg.src = dataUrl;
            document.getElementById('saveModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('saveModal').style.display = 'none';
        }

        function handleLogoSelection() {
            const source = document.getElementById('logoSource').value;
            const uploadArea = document.getElementById('customUploadArea');

            if (source === 'custom') {
                uploadArea.style.display = 'block';
                userLogo = null; 
                document.getElementById('uploadText').innerText = translations[currentLang].uploadText;
                draw();
            } else {
                uploadArea.style.display = 'none';
                if (source === 'bold') {
                    loadPresetLogo('bold.png');
                } else if (source === 'runurban') {
                    loadPresetLogo('runurban.png');
                }
            }
        }

        function handleCustomLogo(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        userLogo = img;
                        document.getElementById('uploadText').innerText = translations[currentLang].logoReady;
                        draw();
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function loadPresetLogo(filename) {
            const img = new Image();
            img.onload = function() {
                userLogo = img;
                draw();
            };
            img.onerror = function() {
                alert(filename + " dosyasƒ± bulunamadƒ±. L√ºtfen dosyanƒ±n HTML ile aynƒ± klas√∂rde olduƒüundan emin olun.");
            };
            img.src = filename;
        }

        function calculatePace() {
            const dist = parseFloat(document.getElementById('distance').value);
            const timeStr = document.getElementById('time').value;

            if (!dist || dist <= 0 || !timeStr) return;

            const parts = timeStr.split(':').map(Number);
            let totalSeconds = 0;
            
            if (parts.length === 3) { 
                totalSeconds = (parts[0] * 3600) + (parts[1] * 60) + parts[2];
            } else if (parts.length === 2) { 
                totalSeconds = (parts[0] * 60) + parts[1];
            } else {
                return;
            }

            const paceSeconds = totalSeconds / dist;
            const pMin = Math.floor(paceSeconds / 60);
            const pSec = Math.floor(paceSeconds % 60);
            
            const formattedPace = `${pMin}:${pSec < 10 ? '0' : ''}${pSec}`;
            
            document.getElementById('pace').value = formattedPace;
            document.getElementById('gap').value = formattedPace;

            draw();
        }

        function drawGraph(graphType, cardY, w) {
            if (graphType === 'none' || !gpxData.hr.length) return;
            
            const graphColor = document.getElementById('graphColor').value;

            let dataPoints = [];

            if(graphType === 'hr') {
                dataPoints = gpxData.hr;
            }
            else if(graphType === 'elevation') {
                dataPoints = gpxData.elevation;
            }
            else if(graphType === 'pace') {
                const rawPace = gpxData.pace;
                const windowSize = 20; // Average over 20 points
                for (let i = 0; i < rawPace.length; i++) {
                    let sum = 0;
                    let count = 0;
                    for (let j = Math.max(0, i - windowSize); j < Math.min(rawPace.length, i + windowSize); j++) {
                        if(rawPace[j] > 0 && rawPace[j] < 20) {
                             sum += rawPace[j];
                             count++;
                        }
                    }
                    dataPoints.push(count > 0 ? sum / count : 0);
                }
            }

            if(dataPoints.length < 2) return;
            
            const graphYOffset = parseInt(document.getElementById('graphYPos').value);

            const graphHeight = 250;
            const graphBottom = cardY + graphYOffset; 
            const graphTop = graphBottom - graphHeight;

            const minVal = Math.min(...dataPoints);
            const maxVal = Math.max(...dataPoints);
            const range = maxVal - minVal;

            ctx.beginPath();
            const stepX = w / (dataPoints.length - 1);
            
            ctx.moveTo(0, graphBottom);

            for (let i = 0; i < dataPoints.length; i++) {
                const val = dataPoints[i];
                const norm = (val - minVal) / (range || 1); 
                
                const x = i * stepX;
                let y;
                if (graphType === 'pace') {
                     y = graphTop + (norm * graphHeight);
                } else {
                     y = graphBottom - (norm * graphHeight);
                }
                
                ctx.lineTo(x, y);
            }

            ctx.lineTo(w, graphBottom);
            ctx.closePath();

            const grad = ctx.createLinearGradient(0, graphTop, 0, graphBottom);
            grad.addColorStop(0, hexToRgba(graphColor, 0.4));
            grad.addColorStop(1, hexToRgba(graphColor, 0.0));
            ctx.fillStyle = grad;
            ctx.fill();

            ctx.beginPath();
             for (let i = 0; i < dataPoints.length; i++) {
                const val = dataPoints[i];
                const norm = (val - minVal) / (range || 1); 
                const x = i * stepX;
                let y;
                if (graphType === 'pace') {
                     y = graphTop + (norm * graphHeight);
                } else {
                     y = graphBottom - (norm * graphHeight);
                }
                if(i===0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.strokeStyle = graphColor;
            ctx.lineWidth = 4;
            ctx.stroke();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const w = canvas.width;
            const yPos = parseInt(document.getElementById('yPos').value);
            const cardY = yPos; 
            const t = translations[currentLang]; 
            
            const selectedFont = document.getElementById('fontSelect').value;
            
            const showShadow = document.getElementById('showShadow').checked;
            if (showShadow) {
                const gradient = ctx.createLinearGradient(0, cardY - 200, 0, cardY + 600);
                gradient.addColorStop(0, "rgba(0,0,0,0)");
                gradient.addColorStop(0.4, "rgba(0,0,0,0.6)");
                gradient.addColorStop(1, "rgba(0,0,0,0.9)");
                ctx.fillStyle = gradient;
                ctx.fillRect(0, cardY - 200, w, 1920 - (cardY - 200));
            }

            const graphType = document.getElementById('graphSelect').value;
            drawGraph(graphType, cardY, w);

            const data = {
                distance: { val: document.getElementById('distance').value, unit: "km", label: t.c_distance },
                time: { val: document.getElementById('time').value, unit: "", label: t.c_time },
                pace: { val: document.getElementById('pace').value, unit: "/km", label: t.c_pace },
                gap: { val: document.getElementById('gap').value, unit: "/km", label: "GAP" }, 
                elevation: { val: document.getElementById('elevation').value, unit: "m", label: t.c_elevation },
                calories: { val: document.getElementById('calories').value, unit: "kcal", label: t.c_calories },
                hr: { val: document.getElementById('hr').value, unit: "bpm", label: t.c_hr }
            };

            const title = document.getElementById('title').value;
            const heroKey = document.getElementById('heroMetric').value;

            // --- √áƒ∞Zƒ∞M ---
            
            ctx.shadowColor = "rgba(0,0,0,0.5)";
            ctx.shadowBlur = 20;
            ctx.textAlign = "left";
            ctx.fillStyle = "white";
            
            let weightTitle = "bold";
            let weightHero = "bold";
            
            if (selectedFont === 'Inter') {
                weightTitle = "900"; 
                weightHero = "900"; 
            }

            ctx.font = `${weightTitle} 35px "${selectedFont}"`;
            ctx.fillText(title, 60, cardY);

            if (userLogo) {
                const logoScale = parseFloat(document.getElementById('logoSize').value);
                const baseMaxH = 120; 
                const baseMaxW = 200;
                const logoMaxH = baseMaxH * logoScale;
                const logoMaxW = baseMaxW * logoScale;
                let lW = userLogo.width;
                let lH = userLogo.height;
                const ratio = lW / lH;
                if (lH > logoMaxH) { lH = logoMaxH; lW = lH * ratio; }
                if (lW > logoMaxW) { lW = logoMaxW; lH = lW / ratio; }
                const logoX = w - 60 - lW;
                const logoY = cardY - 35; 
                ctx.drawImage(userLogo, logoX, logoY, lW, lH);
            }

            const heroData = data[heroKey];
            
            let heroFontSize = 140; 
            if (heroKey === 'time') heroFontSize = 105; 
            
            ctx.font = `${weightHero} ${heroFontSize}px "${selectedFont}"`; 
            let textMetrics = ctx.measureText(heroData.val);
            let textWidth = textMetrics.width;
            const maxHeroWidth = w - 100; 

            if (textWidth > maxHeroWidth) {
                heroFontSize = heroFontSize * (maxHeroWidth / textWidth);
            }

            ctx.font = `${weightHero} ${heroFontSize}px "${selectedFont}"`; 
            ctx.fillStyle = "white";
            ctx.fillText(heroData.val, 50, cardY + 130); 

            const heroWidth = ctx.measureText(heroData.val).width;
            
            ctx.font = `bold 35px "${selectedFont}"`; 
            ctx.fillStyle = "#fc4c02";
            ctx.fillText(heroData.unit, 50 + heroWidth + 15, cardY + 130);

            ctx.font = `bold 22px "${selectedFont}"`; 
            ctx.fillStyle = "#aaa";
            ctx.fillText(heroData.label.toUpperCase(), 60, cardY + 165); 

            const checkedBoxes = document.querySelectorAll('.stat-check:checked');
            let activeStats = Array.from(checkedBoxes)
                .map(cb => cb.value)
                .filter(key => key !== heroKey);

            const count = activeStats.length;
            let rows = [];

            if (count <= 3) {
                rows.push(activeStats);
            } else {
                const splitIndex = Math.ceil(count / 2);
                rows.push(activeStats.slice(0, splitIndex)); 
                rows.push(activeStats.slice(splitIndex));    
            }

            let currentY = cardY + 320;
            
            let labelSize = 28;
            let valueSize = 55;
            let gapX = 320;

            if (activeStats.length <= 4) {
                labelSize = 35; 
                valueSize = 65; 
                gapX = 400;     
            } 
            
            let gapY = 140; 

            rows.forEach((rowItems, rowIndex) => {
                let rowY = currentY + (rowIndex * gapY);

                let startX = 60; 

                rowItems.forEach((key, colIndex) => {
                    const item = data[key];
                    
                    ctx.font = `bold ${labelSize}px "${selectedFont}"`;
                    ctx.fillStyle = "#888";
                    ctx.fillText(item.label, startX + (colIndex * gapX), rowY);

                    ctx.font = `bold ${valueSize}px "${selectedFont}"`;
                    ctx.fillStyle = "white";
                    const valText = item.val + (item.unit ? " " + item.unit : "");
                    ctx.fillText(valText, startX + (colIndex * gapX), rowY + (valueSize + 5));
                });
            });

            ctx.beginPath();
            ctx.moveTo(60, cardY + 260);
            ctx.lineTo(w - 60, cardY + 260);
            ctx.strokeStyle = "rgba(255,255,255,0.15)";
            ctx.lineWidth = 2;
            ctx.stroke();
        }
    </script>
</body>
</html>
